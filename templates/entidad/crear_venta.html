{% extends "base.html" %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Venta</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'css/crea_venta.css' %}">
</head>

<body>
    <div class="container">
        <div class="venta-form">
            <h2>Registro de Venta</h2>
            <div class="messages">
                {% for message in messages %}
                    <p>{{ message }}</p>
                {% endfor %}
            </div>
            <form method="POST">
                {% csrf_token %}
                <div class="form-group">
                    <label for="cliente">Cliente:</label> 
                    <select id="cliente" name="cliente" class="form-control" style="width: 96%;">
                        <option value="">Seleccione un cliente...</option>
                        {% for cliente in clientes %}
                            <option value="{{ cliente.id }}">{{ cliente.dni }} | {{ cliente.nombre|upper }} {{ cliente.apellido|upper }}</option>
                        {% endfor %}
                    </select>
                    <a href="{% url 'nuevo_cliente' %}" class="btn btn-success">+</a>
                </div>
                
                <div class="form-group">
                    <label for="metodo_pago">Método de Pago:</label>
                    <select id="metodo_pago" name="metodo_pago" class="form-control">
                        <option value="">Seleccione un método de pago...</option>
                        <option value="efectivo">Efectivo</option>
                        <option value="tarjeta">Tarjeta</option>
                        <option value="transferencia">Transferencia</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-8">
                        <label for="productos">Agregar producto:</label>
                        <select id="productos" class="form-control" style="width: 100%;">
                            <option value="">Seleccione un producto...</option>
                            {% for producto in productos %}
                                <option value="{{ producto.id }}" 
                                    data-precio="{{ producto.precio }}" 
                                    data-stock="{{ producto.cantidad }}">
                                    {{ producto.id }} | {{ producto.nombre }} | {{ producto.marca }} | ${{ producto.precio }} | Stock: {{ producto.cantidad }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group col-md-2">
                        <label for="cantidad">Cantidad:</label>
                        <input type="number" id="cantidad" class="form-control" placeholder="Cantidad" min="1" value="1">
                    </div>
                    <div class="form-group col-md-2">
                        <button type="button" class="btn btn-primary" onclick="agregarProducto()">Agregar</button>
                    </div>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Quitar</th>
                            <th>Descripción</th>
                            <th>Cantidad</th>
                            <th>Precio</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody id="productos-table">
                        <!-- Aquí se agregarán las filas dinámicamente -->
                    </tbody>
                </table>
                <div class="form-group col-md-2">
                    <label for="descuento">Descuento (%):</label>
                    <input type="number" name="descuento" id="descuento" class="form-control" step="0.01">
                </div>
                <div class="total">Total: $<span id="total-venta">0.00</span></div>
                <input type="hidden" id="productos_json" name="productos" value='[]'>
                <input type="hidden" id="cantidades_json" name="cantidades" value='[]'>
                <button type="submit" class="btn btn-success">Agregar Venta</button>
            </form>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#cliente').select2({
                placeholder: "Buscar cliente...",
                allowClear: true
            });
            $('#productos').select2({
                placeholder: "Buscar producto...",
                allowClear: true
            });
        });

        let productosSeleccionados = [];
        let cantidadesSeleccionadas = [];
        let totalVenta = 0;

        function agregarProducto() {
            const selectProducto = document.getElementById('productos');
            const cantidadInput = document.getElementById('cantidad');

            const productoId = selectProducto.value;
            const cantidad = parseInt(cantidadInput.value);
            const stock = parseInt(selectProducto.options[selectProducto.selectedIndex]?.dataset.stock || 0); // Cambiado para manejar el stock

            if (!productoId) {
                alert("Por favor, seleccione un producto.");
                return;
            }

            if (stock === 0) {
                alert("Este producto no tiene stock disponible.");
                return;
            }

            if (cantidad > stock) {
                alert(`La cantidad solicitada supera el stock disponible (${stock}).`);
                return;
            }

            const precio = parseFloat(selectProducto.options[selectProducto.selectedIndex].dataset.precio);
            let subtotal = precio * cantidad;

            const index = productosSeleccionados.indexOf(productoId);
            if (index !== -1) {
                cantidadesSeleccionadas[index] += cantidad;
                subtotal = precio * cantidadesSeleccionadas[index];
                const row = document.getElementById('productos-table').rows[index];
                row.cells[2].innerText = cantidadesSeleccionadas[index];
                row.cells[4].innerText = `$${subtotal.toFixed(2)}`;
            } else {
                productosSeleccionados.push(productoId);
                cantidadesSeleccionadas.push(cantidad);

                const productosTable = document.getElementById('productos-table');
                const newRow = productosTable.insertRow();

                newRow.innerHTML = `
                    <td><button class="btn btn-danger btn-sm" onclick="quitarProducto(this, ${subtotal})"><i class="fas fa-trash-alt"></i></button></td>
                    <td>${selectProducto.options[selectProducto.selectedIndex].text}</td>
                    <td>${cantidad}</td>
                    <td>$${precio.toFixed(2)}</td>
                    <td>$${subtotal.toFixed(2)}</td>
                `;
            }

            totalVenta += subtotal;
            actualizarTotalConDescuento();

            document.getElementById('productos_json').value = JSON.stringify(productosSeleccionados);
            document.getElementById('cantidades_json').value = JSON.stringify(cantidadesSeleccionadas);

            selectProducto.value = "";
            cantidadInput.value = 1;
        }

        function quitarProducto(button, subtotal) {
            const row = button.parentNode.parentNode;
            const index = row.rowIndex - 1; // Ajustar el índice para productosSeleccionados

            productosSeleccionados.splice(index, 1);
            cantidadesSeleccionadas.splice(index, 1);

            totalVenta -= subtotal;
            actualizarTotalConDescuento();

            row.remove();
        }

        function actualizarTotalConDescuento() {
            const descuentoInput = document.getElementById('descuento');
            const descuento = parseFloat(descuentoInput.value) || 0;
            const totalConDescuento = totalVenta - (totalVenta * (descuento / 100));
            document.getElementById('total-venta').innerText = totalConDescuento.toFixed(2);
        }

        document.querySelector("form").addEventListener("submit", function(event) {
            if (productosSeleccionados.length === 0) {
                event.preventDefault();
                alert("No hay productos seleccionados para la venta.");
            }
        });

        document.getElementById('descuento').addEventListener('input', function () {
            const descuento = parseFloat(this.value);
            if (descuento < 0 || descuento > 100) {
                alert("El descuento debe estar entre 0 y 100.");
                this.value = '';
            } else {
                actualizarTotalConDescuento();
            }
        });
    </script>
</body>

</html>
{% endblock %}
